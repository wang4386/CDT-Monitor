<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿里云 CDT 监控控制台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    colors: {
                        ios: {
                            bg: '#F2F2F7',
                            card: 'rgba(255, 255, 255, 0.72)',
                            blue: '#007AFF',
                            black: '#1C1C1E',
                            red: '#FF3B30',
                            green: '#34C759',
                            gray: '#8E8E93',
                        }
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>
    <style>
        /* 核心修复：添加 !important 防止 Tailwind 的 flex/block 类覆盖隐藏效果 */
        [v-cloak] { display: none !important; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 
                0 1px 2px rgba(0,0,0,0.02),
                0 8px 32px rgba(0,0,0,0.04),
                inset 0 0 0 1px rgba(255,255,255,0.2);
        }
        
        .glass-input {
            background: rgba(242, 242, 247, 0.5);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.2s;
        }
        .glass-input:focus {
            background: #fff;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.05);
        }
        
        .tap-effect:active {
            transform: scale(0.96);
            transition: transform 0.1s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        /* Tooltip 动画 - 响应式优化 */
        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            /* 移动端默认: 靠左定位，微调偏移，避免居中导致的左侧溢出 */
            left: -2rem; 
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .group:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* PC 端 (md): 恢复完美居中 */
        @media (min-width: 768px) {
            .tooltip-content {
                left: 50%;
                transform: translateY(10px) translateX(-50%);
            }
            .group:hover .tooltip-content {
                transform: translateY(0) translateX(-50%);
            }
        }

        /* 下拉选择框动画 */
        .dropdown-enter-active,
        .dropdown-leave-active {
            transition: all 0.2s ease;
        }
        .dropdown-enter-from,
        .dropdown-leave-to {
            opacity: 0;
            transform: translateY(-10px);
        }

        body { background-color: #F2F2F7; }
    </style>
</head>
<body class="text-[#1C1C1E]">

<div id="app" v-cloak class="min-h-screen p-6 md:p-12 flex flex-col items-center">
    
    <!-- Header -->
    <header class="w-full max-w-5xl flex justify-between items-center mb-10 px-2">
        <div>
            <h1 class="text-2xl font-bold tracking-tight text-[#1C1C1E]">CDT Monitor</h1>
            <p class="text-xs font-semibold tracking-widest text-gray-400 uppercase mt-1">Status & Control</p>
        </div>
        
        <button v-if="initialized && !checkingLogin && !criticalError" @click="toggleAdmin" 
            class="tap-effect px-5 py-2 rounded-full text-sm font-medium transition-all duration-300"
            :class="isAdmin ? 'bg-[#1C1C1E] text-white shadow-lg' : 'bg-white text-gray-600 shadow-sm border border-gray-200'">
            {{ isAdmin ? '退出管理' : '管理员登录' }}
        </button>
    </header>

    <!-- Main Status Grid -->
    <main v-if="initialized && !loading && !criticalError" class="w-full max-w-5xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in-up">
        <div v-for="(item, index) in statusData" :key="index" 
             class="glass-panel rounded-[32px] p-6 flex flex-col justify-between relative overflow-hidden group hover:shadow-2xl transition-all duration-500">
            <div class="absolute top-0 right-0 p-6 opacity-50">
                <div class="w-2 h-2 rounded-full transition-colors duration-500" 
                     :class="item.rate95 ? 'bg-red-500 shadow-[0_0_10px_rgba(255,59,48,0.5)]' : 'bg-green-500 shadow-[0_0_10px_rgba(52,199,89,0.5)]'"></div>
            </div>
            <div>
                <div class="flex items-center gap-2 mb-4">
                    <span class="px-2 py-1 bg-gray-100/50 rounded-lg text-[10px] font-bold tracking-wider text-gray-500 uppercase border border-white/40">{{ item.regionName }}</span>
                    <span class="text-[10px] text-gray-400">{{ item.lastUpdated ? item.lastUpdated.split(' ')[1] : '' }} 更新</span>
                </div>
                <h3 class="text-3xl font-extrabold tracking-tighter text-[#1C1C1E]">
                    {{ item.flow_used }} <span class="text-base font-medium text-gray-400">GB</span>
                </h3>
                <div class="flex justify-between items-end mt-1">
                     <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">已用流量</p>
                     <p class="text-xs font-medium text-gray-400">{{ item.percentageOfUse }}% / {{ item.flow_total }}G</p>
                </div>
                <div class="w-full h-1.5 bg-gray-200/50 rounded-full mt-3 overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-1000 ease-out"
                         :class="item.rate95 ? 'bg-[#FF3B30]' : 'bg-[#1C1C1E]'"
                         :style="{ width: Math.min(item.percentageOfUse, 100) + '%' }"></div>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-200/40 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-500">运行状态</span>
                    <span class="text-sm font-bold" :class="getInstanceStatusColor(item.instanceStatus)">{{ item.instanceStatus }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-500">账号</span>
                    <span class="text-sm font-medium text-[#1C1C1E] font-mono">{{ item.account }}</span>
                </div>
                 <div class="flex justify-between items-center">
                    <span class="text-xs font-medium text-gray-400">当前阈值</span>
                    <span class="text-xs font-medium text-gray-400">{{ item.threshold }}%</span>
                </div>
            </div>
        </div>
        <!-- If no accounts -->
        <div v-if="statusData.length === 0" class="col-span-full py-20 text-center text-gray-400">
            <p>暂无监控账号，请点击右上角登录管理员添加。</p>
        </div>
    </main>
    
    <div v-if="initialized && loading && !criticalError" class="w-full h-64 flex items-center justify-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-800"></div>
    </div>

    <!-- Critical Error Modal (e.g., DB Permissions) -->
    <div v-if="criticalError" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-red-50/50 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md p-8 rounded-[40px] shadow-xl border-red-200 bg-red-50/80">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg font-medium leading-6 text-red-900">系统初始化错误</h3>
                <div class="mt-2 px-2 py-3">
                    <p class="text-sm text-red-700 break-words font-mono bg-red-100/50 p-2 rounded-lg">{{ criticalError }}</p>
                </div>
                <p class="mt-4 text-xs text-gray-500">
                    请检查服务器目录权限，确保 Web 用户 (如 www) 对当前目录有写入权限以创建数据库文件。
                </p>
                <div class="mt-6">
                    <button @click="location.reload()" class="w-full inline-flex justify-center rounded-xl border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm">
                        重试
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div v-if="showLoginModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-gray-200/30 backdrop-blur-md" @click="showLoginModal = false"></div>
        <div class="glass-panel w-full max-w-md p-8 rounded-[40px] relative z-10 transform transition-all shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-center">管理员验证</h2>
            <input type="password" v-model="passwordInput" placeholder="请输入配置密码" 
                   class="w-full glass-input px-4 py-3 rounded-xl border border-transparent focus:outline-none transition-all text-center text-lg mb-6">
            <button @click="performLogin" class="w-full bg-[#1C1C1E] text-white py-3 rounded-2xl font-semibold tap-effect shadow-lg">
                解锁控制台
            </button>
        </div>
    </div>

    <!-- Setup Wizard (Initialization) -->
    <div v-if="!initialized && !loadingCheckInit && !criticalError" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 bg-[#F2F2F7]">
        <div class="glass-panel w-full max-w-lg p-10 rounded-[48px] shadow-2xl border border-white/80">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-extrabold text-[#1C1C1E] mb-2">欢迎使用 CDT Monitor</h1>
                <p class="text-gray-500 text-sm">初次使用，请先配置核心参数。</p>
            </div>

            <div class="space-y-6">
                <!-- Step 1: Admin Password -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 ml-2 uppercase tracking-wider">设置管理员密码 <span class="text-red-500">*</span></label>
                    <input type="text" v-model="setupData.admin_password" placeholder="用于登录后台管理" class="w-full glass-input rounded-2xl px-5 py-3 text-base focus:ring-2 focus:ring-gray-200 focus:bg-white transition-all">
                </div>

                <!-- Step 2: Global Settings (Simplified) -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 ml-2 uppercase tracking-wider">流量阈值 (%)</label>
                        <input type="number" v-model.number="setupData.traffic_threshold" class="w-full glass-input rounded-2xl px-5 py-3 text-base">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 ml-2 uppercase tracking-wider">停机模式</label>
                        <select v-model="setupData.shutdown_mode" class="w-full glass-input rounded-2xl px-5 py-3 text-base appearance-none bg-transparent">
                            <option value="KeepCharging">普通停机</option>
                            <option value="StopCharging">节省停机</option>
                        </select>
                    </div>
                </div>

                <!-- Action -->
                <button @click="performSetup" :disabled="!setupData.admin_password" 
                    class="w-full bg-[#1C1C1E] text-white py-4 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl hover:scale-[1.02] active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                    初始化系统
                </button>
                <p class="text-center text-[10px] text-gray-400">点击后将创建本地数据库并自动登录。</p>
            </div>
        </div>
    </div>

    <!-- Admin Config Editor -->
    <div v-if="isAdmin && config" class="w-full max-w-5xl mt-12 mb-20 animate-fade-in-up space-y-8">
        <div class="flex items-center gap-4">
            <h2 class="text-xl font-bold">系统配置</h2>
            <div class="h-px bg-gray-300 flex-1"></div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Global Settings -->
                <div class="glass-panel rounded-[32px] p-6 overflow-visible z-20"> 
                    <h3 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">全局设置</h3>
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500 ml-2">管理员密码</label>
                            <input v-model="config.admin_password" type="text" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500 ml-2">告警阈值 (%)</label>
                            <input v-model.number="config.traffic_threshold" type="number" min="1" max="100" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                        </div>
                        
                        <!-- 停机模式 (带 Tooltip) -->
                        <div class="space-y-1 relative">
                            <div class="flex items-center gap-1">
                                <label class="text-xs font-medium text-gray-500 ml-2">停机模式</label>
                                <!-- Tooltip Trigger -->
                                <div class="group relative flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3.5 h-3.5 text-gray-400 cursor-help hover:text-gray-600 transition-colors">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                                    </svg>
                                    
                                    <!-- Tooltip Content -->
                                    <div class="tooltip-content absolute bottom-full mb-2 w-64 md:w-80 p-4 bg-[#1C1C1E]/95 backdrop-blur-md text-white text-xs rounded-2xl shadow-[0_8px_30px_rgba(0,0,0,0.3)] z-50 border border-gray-700 pointer-events-none text-left leading-relaxed">
                                        <div class="space-y-3">
                                            <div>
                                                <h4 class="text-orange-400 font-bold mb-1">普通停机模式 (KeepCharging)</h4>
                                                <p class="text-gray-300">停止实例后保留实例的资源并继续收费。</p>
                                                <p class="text-gray-400 mt-1 opacity-80">建议场景：更换操作系统、重新初始化云盘、更改实例规格、修改私网IP等操作。可避免启动失败。</p>
                                            </div>
                                            <div class="w-full h-px bg-gray-700/50"></div>
                                            <div>
                                                <h4 class="text-green-400 font-bold mb-1">节省停机模式 (StopCharging)</h4>
                                                <p class="text-gray-300">计算资源(CPU/内存)、固定公网IP带宽暂停计费。</p>
                                                <p class="text-gray-400 mt-1 opacity-80">注意：计算资源被回收，重新启动时可能因库存不足失败。固定公网IP可能会变，弹性公网IP(EIP)不会变。</p>
                                            </div>
                                        </div>
                                        <!-- Arrow: 移动端靠左(left-10)，PC端居中 -->
                                        <div class="absolute top-full left-10 md:left-1/2 md:-translate-x-1/2 -mt-2 border-8 border-transparent border-t-[#1C1C1E]/95"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <select v-model="config.shutdown_mode" class="w-full glass-input rounded-xl px-4 py-2 text-sm appearance-none cursor-pointer">
                                <option value="KeepCharging">普通停机 (保留IP/收费)</option>
                                <option value="StopCharging">节省停机 (回收IP/免费)</option>
                            </select>
                        </div>
                        
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500 ml-2">流量阈值动作</label>
                            <select v-model="config.threshold_action" class="w-full glass-input rounded-xl px-4 py-2 text-sm appearance-none cursor-pointer">
                                <option value="stop_and_notify">自动关机并告警 (默认)</option>
                                <option value="notify_only">仅发送告警 (不关机)</option>
                            </select>
                            <p class="text-[10px] text-gray-400 px-2 mt-1">达到流量阈值时触发的操作。</p>
                        </div>

                        <!-- 实例保活 (新增) -->
                        <div class="flex items-center justify-between pt-2">
                            <div class="flex items-center gap-1">
                                <label class="text-xs font-medium text-gray-500 ml-2">实例保活 (抢占式)</label>
                                <!-- Tooltip Trigger -->
                                <div class="group relative flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3.5 h-3.5 text-gray-400 cursor-help hover:text-gray-600 transition-colors">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                                    </svg>
                                    
                                    <!-- Tooltip Content -->
                                    <div class="tooltip-content absolute bottom-full mb-2 w-64 md:w-72 p-4 bg-[#1C1C1E]/95 backdrop-blur-md text-white text-xs rounded-2xl shadow-[0_8px_30px_rgba(0,0,0,0.3)] z-50 border border-gray-700 pointer-events-none text-left leading-relaxed">
                                        <p class="text-gray-300">防止抢占式实例在<span class="text-green-400 font-bold">非关机时间段</span>被意外释放。</p>
                                        <div class="w-full h-px bg-gray-700/50 my-2"></div>
                                        <p class="text-gray-400 opacity-80">开启后，如果在“开机时间段”内检测到实例状态为“关机”且流量未超标，程序将尝试自动执行开机操作。</p>
                                        <div class="absolute top-full left-10 md:left-1/2 md:-translate-x-1/2 -mt-2 border-8 border-transparent border-t-[#1C1C1E]/95"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="relative inline-block w-10 mr-2">
                                <input type="checkbox" v-model="config.keep_alive" id="toggle-keep-alive" class="peer sr-only"/>
                                <label for="toggle-keep-alive" class="block overflow-hidden h-5 w-10 rounded-full bg-gray-300 cursor-pointer transition-colors peer-checked:bg-[#1C1C1E]"></label>
                                <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></div>
                            </div>
                        </div>

                         <div class="flex items-center justify-between pt-2">
                            <label class="text-xs font-medium text-gray-500 ml-2">定时任务邮件通知</label>
                            <div class="relative inline-block w-10 mr-2">
                                <input type="checkbox" v-model="config.enable_schedule_email" id="toggle-sched" class="peer sr-only"/>
                                <label for="toggle-sched" class="block overflow-hidden h-5 w-10 rounded-full bg-gray-300 cursor-pointer transition-colors peer-checked:bg-[#1C1C1E]"></label>
                                <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="glass-panel rounded-[32px] p-6 z-10">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">邮件服务器配置</h3>
                    <div class="space-y-3">
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500 ml-2">SMTP Host</label>
                            <input v-model="config.Notification.host" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                        </div>
                         <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-gray-500 ml-2">Port</label>
                                <input v-model="config.Notification.port" type="number" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-gray-500 ml-2">Secure</label>
                                <select v-model="config.Notification.secure" class="w-full glass-input rounded-xl px-4 py-2 text-sm appearance-none">
                                    <option value="ssl">SSL</option>
                                    <option value="tls">TLS</option>
                                    <option value="">无 (None)</option>
                                </select>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500 ml-2">Username</label>
                            <input v-model="config.Notification.username" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500 ml-2">Password</label>
                            <input v-model="config.Notification.password" type="password" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-medium text-gray-500 ml-2">Receiver Email</label>
                            <input v-model="config.Notification.email" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                        </div>

                        <div class="pt-4">
                            <button @click="sendTestEmail" :disabled="sendingEmail" class="w-full border border-gray-300 text-gray-600 py-2 rounded-xl text-xs font-semibold hover:bg-gray-50 transition disabled:opacity-50">
                                {{ sendingEmail ? '发送中...' : '发送测试邮件' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column (Accounts) -->
            <div class="lg:col-span-2 glass-panel rounded-[40px] p-8 h-fit z-0">
                <div class="space-y-8">
                    <div v-for="(acc, idx) in config.Accounts" :key="idx" class="p-6 bg-white/40 rounded-[28px] border border-white/60 relative hover:bg-white/60 transition-colors">
                        <button @click="removeAccount(idx)" class="absolute top-4 right-4 text-xs text-red-500 font-bold hover:bg-red-50 p-2 rounded-lg transition">移除</button>
                        
                        <h3 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">账号 {{ idx + 1 }}</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-gray-500 ml-2">AccessKey ID</label>
                                <input v-model="acc.AccessKeyId" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-gray-500 ml-2">AccessKey Secret</label>
                                <input v-model="acc.AccessKeySecret" type="password" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-gray-500 ml-2">Instance ID</label>
                                <input v-model="acc.instanceId" placeholder="实例 ID (必填)" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                            </div>
                             <div class="space-y-1 relative">
                                <label class="text-xs font-medium text-gray-500 ml-2">Region ID</label>
                                <input v-model="acc.regionId" 
                                       @focus="regionSearchFocus = idx" 
                                       @blur="setTimeout(() => regionSearchFocus = -1, 200)"
                                       placeholder="输入地域名称或代码..." 
                                       class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                                
                                <!-- 智能下拉提示框 -->
                                <transition name="dropdown">
                                    <div v-show="regionSearchFocus === idx" class="absolute left-0 right-0 top-full mt-2 bg-white/90 backdrop-blur-md border border-gray-200 rounded-xl shadow-xl z-50 max-h-60 overflow-y-auto no-scrollbar">
                                        <ul>
                                            <li v-for="region in aliyunRegions.filter(r => !acc.regionId || r.id.toLowerCase().includes(acc.regionId.toLowerCase()) || r.name.includes(acc.regionId))" 
                                                @click="acc.regionId = region.id; regionSearchFocus = -1"
                                                class="px-4 py-2 text-xs hover:bg-gray-100 cursor-pointer border-b border-gray-100/50 last:border-0 flex justify-between items-center group">
                                                <span class="font-medium text-gray-800">{{ region.name }}</span>
                                                <span class="text-[10px] text-gray-400 group-hover:text-gray-600 font-mono">{{ region.id }}</span>
                                            </li>
                                            <li v-if="aliyunRegions.filter(r => !acc.regionId || r.id.toLowerCase().includes(acc.regionId.toLowerCase()) || r.name.includes(acc.regionId)).length === 0" class="px-4 py-3 text-xs text-gray-400 text-center">
                                                无匹配地域
                                            </li>
                                        </ul>
                                    </div>
                                </transition>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-gray-500 ml-2">Max Traffic (GB)</label>
                                <input v-model.number="acc.maxTraffic" type="number" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                            </div>
                        </div>

                        <div class="mt-6 pt-4 border-t border-gray-200/50">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="relative inline-block w-8 mr-1">
                                    <input type="checkbox" v-model="acc.schedule.enabled" :id="'sched-'+idx" class="peer sr-only"/>
                                    <label :for="'sched-'+idx" class="block overflow-hidden h-4 w-8 rounded-full bg-gray-300 cursor-pointer transition-colors peer-checked:bg-[#1C1C1E]"></label>
                                    <div class="absolute left-0.5 top-0.5 w-3 h-3 bg-white rounded-full transition-transform peer-checked:translate-x-4"></div>
                                </div>
                                <span class="text-sm font-bold text-gray-700">启用定时开关机</span>
                            </div>
                            
                            <div v-if="acc.schedule && acc.schedule.enabled" class="flex flex-wrap gap-4 items-center animate-fade-in">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500">开机时间</span>
                                    <input type="time" v-model="acc.schedule.startTime" class="bg-white/80 border border-gray-200 rounded-lg px-2 py-1 text-sm">
                                </div>
                                <div class="w-4 h-px bg-gray-300"></div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500">关机时间</span>
                                    <input type="time" v-model="acc.schedule.stopTime" class="bg-white/80 border border-gray-200 rounded-lg px-2 py-1 text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button @click="addAccount" class="w-full py-4 rounded-2xl border border-dashed border-gray-300 text-gray-400 hover:bg-white/40 hover:text-gray-600 transition font-medium">+ 添加账号</button>

                    <div class="flex justify-end pt-6">
                        <button @click="saveConfig" class="bg-[#1C1C1E] text-white px-10 py-4 rounded-2xl font-bold shadow-xl tap-effect hover:shadow-2xl transition-all">保存所有配置</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            const statusData = ref([]);
            const config = ref(null);
            const loading = ref(true);
            const isAdmin = ref(false);
            const checkingLogin = ref(true); 
            const showLoginModal = ref(false);
            const passwordInput = ref('');
            const sendingEmail = ref(false);
            const criticalError = ref(null); // 新增：严重错误状态
            
            const initialized = ref(true); 
            const loadingCheckInit = ref(true);
            
            // 下拉框状态管理
            const regionSearchFocus = ref(-1); // 存储当前聚焦的账号索引
            
            // 阿里云地域数据
            const aliyunRegions = [
                { id: 'cn-hongkong', name: '中国香港' },
                { id: 'ap-southeast-1', name: '新加坡' },
                { id: 'ap-northeast-1', name: '日本 (东京)' },
                { id: 'us-west-1', name: '美国 (硅谷)' },
                { id: 'us-east-1', name: '美国 (弗吉尼亚)' },
                { id: 'eu-central-1', name: '德国 (法兰克福)' },
                { id: 'eu-west-1', name: '英国 (伦敦)' },
                { id: 'ap-southeast-2', name: '澳大利亚 (悉尼)' },
                { id: 'ap-southeast-3', name: '马来西亚 (吉隆坡)' },
                { id: 'ap-southeast-5', name: '印度尼西亚 (雅加达)' },
                { id: 'ap-southeast-6', name: '菲律宾 (马尼拉)' },
                { id: 'ap-southeast-7', name: '泰国 (曼谷)' },
                { id: 'ap-northeast-2', name: '韩国 (首尔)' },
                { id: 'me-east-1', name: '阿联酋 (迪拜)' },
                { id: 'cn-hangzhou', name: '华东1 (杭州)' },
                { id: 'cn-shanghai', name: '华东2 (上海)' },
                { id: 'cn-qingdao', name: '华北1 (青岛)' },
                { id: 'cn-beijing', name: '华北2 (北京)' },
                { id: 'cn-zhangjiakou', name: '华北3 (张家口)' },
                { id: 'cn-huhehaote', name: '华北5 (呼和浩特)' },
                { id: 'cn-wulanchabu', name: '华北6 (乌兰察布)' },
                { id: 'cn-shenzhen', name: '华南1 (深圳)' },
                { id: 'cn-heyuan', name: '华南2 (河源)' },
                { id: 'cn-guangzhou', name: '华南3 (广州)' },
                { id: 'cn-chengdu', name: '西南1 (成都)' }
            ];

            const setupData = ref({
                admin_password: '',
                traffic_threshold: 95,
                shutdown_mode: 'KeepCharging',
                threshold_action: 'stop_and_notify',
                keep_alive: false,
                enable_schedule_email: false,
                Notification: {
                    email: '', host: '', port: 465, secure: 'ssl', username: '', password: ''
                },
                Accounts: []
            });

            // 1. 先检查是否初始化
            const checkInitStatus = async () => {
                loadingCheckInit.value = true;
                try {
                    const res = await fetch('index.php?action=check_init');
                    const data = await res.json();
                    
                    if (data.error) {
                        criticalError.value = data.error;
                        loading.value = false;
                        return;
                    }

                    initialized.value = data.initialized;
                    
                    if (data.initialized) {
                        checkLoginStatus();
                    } else {
                        loading.value = false; // 显示初始化向导
                    }
                } catch (e) {
                    console.error('Init check failed', e);
                    criticalError.value = "无法连接到服务器或响应格式错误。";
                    loading.value = false;
                } finally {
                    loadingCheckInit.value = false;
                }
            };

            const performSetup = async () => {
                try {
                    const res = await fetch('index.php?action=setup', {
                        method: 'POST',
                        body: JSON.stringify(setupData.value)
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert('系统初始化成功！');
                        location.reload(); 
                    } else {
                        alert('初始化失败: ' + (data.message || '未知错误'));
                    }
                } catch(e) {
                    alert('网络请求失败');
                }
            };

            const checkLoginStatus = async () => {
                checkingLogin.value = true;
                try {
                    const res = await fetch('index.php?action=check_login');
                    const data = await res.json();
                    if (data.logged_in) {
                        isAdmin.value = true;
                        fetchConfig(); 
                    }
                    fetchData();
                } catch (e) {
                    console.error('Session check failed', e);
                } finally {
                    checkingLogin.value = false;
                }
            };

            const fetchData = async () => {
                loading.value = true;
                try {
                    const res = await fetch('index.php?action=get_status');
                    const json = await res.json();
                    
                    if (json.error) {
                        criticalError.value = json.error;
                    } else {
                        statusData.value = json.data || []; 
                    }
                } catch (e) {
                    console.error(e);
                    statusData.value = [];
                } finally {
                    loading.value = false;
                }
            };

            // ... (Other functions remain same) ...
            
            const toggleAdmin = () => {
                if (isAdmin.value) {
                    fetch('index.php?action=logout').then(() => {
                        isAdmin.value = false;
                        config.value = null;
                    });
                } else {
                    showLoginModal.value = true;
                }
            };

            const performLogin = async () => {
                try {
                    const res = await fetch('index.php?action=login', {
                        method: 'POST',
                        body: JSON.stringify({ password: passwordInput.value })
                    });
                    const data = await res.json();
                    if (data.success) {
                        isAdmin.value = true;
                        showLoginModal.value = false;
                        passwordInput.value = '';
                        fetchConfig();
                    } else {
                        alert('密码错误');
                    }
                } catch(e) {
                    alert('登录请求失败');
                }
            };

            const fetchConfig = async () => {
                try {
                    const res = await fetch('index.php?action=get_config');
                    const data = await res.json();
                    if (!data.Accounts) data.Accounts = [];
                    data.Accounts.forEach(acc => {
                        if(!acc.schedule) acc.schedule = { enabled: false, startTime: '', stopTime: '' };
                        if(typeof acc.maxTraffic === 'undefined') acc.maxTraffic = 200;
                    });
                    if (!data.Notification) data.Notification = { email: '', host: '', port: 465, secure: 'ssl', username: '', password: '' };
                    config.value = data;
                } catch(e) { console.error(e); }
            };

            const saveConfig = async () => {
                if (!config.value) return;
                try {
                    const res = await fetch('index.php?action=save_config', { method: 'POST', body: JSON.stringify(config.value) });
                    const data = await res.json();
                    if (data.success) { alert('配置已保存'); fetchData(); } else { alert('保存失败'); }
                } catch(e) { alert('保存请求失败'); }
            };

            const sendTestEmail = async () => {
                if (!config.value || !config.value.Notification.email) { alert('请先填写接收邮箱并保存配置'); return; }
                if(!confirm('发送测试邮件将使用已保存的配置。继续发送吗？')) { return; }
                sendingEmail.value = true;
                try {
                    const res = await fetch('index.php?action=send_test_email', { method: 'POST', body: JSON.stringify({ email: config.value.Notification.email }) });
                    const data = await res.json();
                    if (data.success) { alert('邮件发送成功！'); } else { alert('邮件发送失败'); }
                } catch(e) { alert('发送请求失败'); } finally { sendingEmail.value = false; }
            };

            const addAccount = () => {
                if(!config.value.Accounts) config.value.Accounts = [];
                config.value.Accounts.push({ AccessKeyId: '', AccessKeySecret: '', maxTraffic: 200, regionId: 'cn-hongkong', instanceId: '', schedule: { enabled: false, startTime: '', stopTime: '' } });
            };

            const removeAccount = (index) => { if(confirm('确定删除该账号配置？')) config.value.Accounts.splice(index, 1); };
            
            const getInstanceStatusColor = (status) => {
                const map = { 'Running': 'text-green-500', 'Stopped': 'text-red-500', 'Starting': 'text-yellow-500', 'Stopping': 'text-yellow-500' };
                return map[status] || 'text-gray-400';
            };

            onMounted(() => {
                checkInitStatus();
            });

            return {
                statusData, loading, isAdmin, checkingLogin, showLoginModal, passwordInput, config, initialized, loadingCheckInit, setupData, criticalError,
                regionSearchFocus, aliyunRegions, // 导出新变量
                toggleAdmin, performLogin, saveConfig, sendTestEmail, sendingEmail, addAccount, removeAccount, getInstanceStatusColor, performSetup
            };
        }
    }).mount('#app');
</script>
</body>
</html>